<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nidhi @ 40 ‚Äî Live Love Notes Wall</title>
  <style>
    :root{--pink:#ff2ea6;--ink:#101010;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:#fff}
    header{position:sticky;top:0;background:linear-gradient(90deg,#fff,#ffe7f4);padding:14px 18px;border-bottom:2px solid #ffd2ea;display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:20px}
    .dot{width:10px;height:10px;border-radius:50%;background:#bbb;display:inline-block;margin-left:8px}
    .dot.ok{background:#22c55e}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;padding:18px}
    .card{border:2px solid #ffd2ea;border-radius:18px;padding:16px;background:#fff;box-shadow:0 6px 16px rgba(255,46,166,.12)}
    .name{font-weight:700;color:#c9006c;margin-bottom:8px}
    .msg{font-size:16px;line-height:1.35;}
    .muted{color:#666}
    .actions{margin-top:10px;display:flex;gap:10px}
    .like-btn,.del-btn{background:none;border:none;cursor:pointer;color:#c9006c;font-size:14px;display:flex;align-items:center;gap:4px;padding:4px 6px;border-radius:8px}
    .like-btn:hover,.del-btn:hover{background:#ffe7f4}
  </style>
</head>
<body>
  <header>
    <h1>Love Notes for Nidhi <span class="muted">(auto‚Äërefreshing)</span></h1>
    <div><span class="muted">Status</span><span id="dot" class="dot"></span></div>
  </header>
  <section id="grid" class="grid"></section>
  <script>
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbygYMSwCALqz_0PC3CQ7v0QtRkGa2wQVJZuPKaZqS0quaPcoOzolrHxjux1sNgYEmMz2A/exec';
    const grid = document.getElementById('grid');
    const dot  = document.getElementById('dot');
    let lastCount = 0;
    const own = new Set(JSON.parse(localStorage.getItem('nidhi40_own')||'[]'));
    const params = new URLSearchParams(location.search);
    if(params.get('admin')==='1') localStorage.setItem('nidhi40_admin','1');
    if(params.get('admin')==='0') localStorage.removeItem('nidhi40_admin');
    const isAdmin = localStorage.getItem('nidhi40_admin')==='1';

    async function load(){
      try{
        const res = await fetch(ENDPOINT_URL+"?mode=list");
        const data = await res.json();
        if(!data.ok) throw new Error('not ok');
        dot.classList.add('ok');
        const allItems = data.items.filter(x=>x.consent);
        if(allItems.length!==lastCount){
          const hidden = new Set(JSON.parse(localStorage.getItem('nidhi40_hidden')||'[]'));
            const display = allItems.filter(it=>!hidden.has(getId(it)));
          grid.innerHTML = display.slice(-120).map(render).join('');
          lastCount = allItems.length;
        }
      }catch(e){ dot.classList.remove('ok'); }
    }

    function render(it){
      const name = escapeHtml(it.name||'');
      const msg  = escapeHtml(it.message||'');
        const id   = getId(it);
        const likes = Number(localStorage.getItem('nidhi40_like_'+id)||0);
        const key = makeKey(it.name||'', it.message||'');
        const del = (isAdmin || own.has(key)) ? '<button class="del-btn">üóëÔ∏è</button>' : '';
        return `<article class="card" data-id="${id}"><div class="name">${name}</div><div class="msg">${msg}</div><div class="actions"><button class="like-btn">‚ù§Ô∏è <span class="count">${likes}</span></button>${del}</div></article>`;
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

      function makeKey(name,msg){
        return btoa(unescape(encodeURIComponent(name.trim()+"|"+msg.trim())));
      }

      function getId(it){
        return String(it.ts || makeKey(it.name||'', it.message||''));
      }
    grid.addEventListener('click', e=>{
      const card = e.target.closest('.card');
      if(!card) return;
      const id = card.dataset.id;
      if(e.target.closest('.like-btn')){
        const key = 'nidhi40_like_'+id;
        let c = Number(localStorage.getItem(key)||0)+1;
        localStorage.setItem(key,c);
        card.querySelector('.count').textContent = c;
      } else if(e.target.closest('.del-btn')){
        card.remove();
        const key = 'nidhi40_hidden';
        const hidden = JSON.parse(localStorage.getItem(key)||'[]');
        if(!hidden.includes(id)){
          hidden.push(id);
          localStorage.setItem(key, JSON.stringify(hidden));
        }
      }
    });

    load(); setInterval(load, 4000);
  </script>
</body>
</html>
